{% extends "base.html" %}

{% block content %}

<div class="page-header">
  <h1>Injury Replacements</h1>
  <p class="page-subtitle">Browse injured players or search by name -> get ranked replacements candidates</p>
</div>

<!-- VIEW TOGGLE -->
<div class="view-toggle">
  <button class="view-btn active" data-view="browse" id="btn-browse">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
      <circle cx="9" cy="7" r="4"/>
      <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
    </svg>
    Injured Players
  </button>
  <button class="view-btn" data-view="search" id="btn-search">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    Search Player
  </button>
</div>

<!-- TAB A: INJURED PLAYERS  -->
<div id="view-browse">
  {% if injured_players %}
  <div class="browse-header">
    <h2>All Injured Players</h2>
    <span class="results-count">{{ injured_players | length }} players</span>
  </div>

  <!-- Position filter tabs -->
  <div class="filter-bar">
    <button class="filter-pill active" data-filter="all">All</button>
    {% set positions = injured_players | map(attribute='position') | select | unique | sort | list %}
    {% for pos in positions %}
      <button class="filter-pill" data-filter="{{ pos }}">{{ pos }}</button>
    {% endfor %}
  </div>

  <div class="table-wrapper" style="max-width:900px; margin: 0 auto 2rem;">
    <table class="results-table" id="injured-table">
      <thead>
        <tr>
          <th class="col-rank">#</th>
          <th>Player</th>
          <th class="col-center">Pos</th>
          <th class="col-center">Team</th>
          <th class="col-center">Avg Pts</th>
          <th class="col-center">Injury</th>
          <th class="col-center">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for player in injured_players %}
        <tr class="result-row inj-row" data-position="{{ player.position or '' }}">
          <td class="col-rank"><span class="rank-num">{{ loop.index }}</span></td>
          <td><span class="player-name">{{ player.name or "—" }}</span></td>
          <td class="col-center">
            {% if player.position %}
              <span class="pos-badge pos-{{ player.position | lower }}">{{ player.position }}</span>
            {% else %}—{% endif %}
          </td>
          <td class="col-center">
            <span class="team-label-sm">{{ player.proTeam or player.team or "—" }}</span>
          </td>
          <td class="col-center">
            <span class="avg-value">
              {% if player.avg_points is not none %}{{ "%.1f" | format(player.avg_points) }}{% else %}—{% endif %}
            </span>
          </td>
          <td class="col-center">
            <span class="status-badge status-injured">Injured</span>
          </td>
          <td class="col-center">
            <form method="POST" action="{{ url_for('replacements') }}" style="margin:0">
              {{ form.hidden_tag() }}
              <input type="hidden" name="search" value="{{ player.name }}">
              <button type="submit" class="find-btn">Find Replacements</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% else %}
  <div class="empty-state">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" opacity="0.3">
      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
    </svg>
    <p>No injured players found in the database.</p>
  </div>
  {% endif %}
</div>

<!-- TAB B: SEARCH SPECIFIC PLAYER -->
<div id="view-search" class="hidden">

  <!-- SEARCH FORM -->
  <div class="search-section">
    <form method="POST" action="{{ url_for('replacements') }}" id="search-form">
      {{ form.hidden_tag() }}
      <div class="search-bar">
        {{ form.search(
            id="player-search",
            placeholder="e.g. Joel Embiid...",
            autocomplete="off",
            class="search-input"
        ) }}
        <button type="submit" class="search-btn" id="submit-btn">
          <span class="btn-text">Find Replacements</span>
          <span class="btn-spinner btn-hidden">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
            </svg>
          </span>
        </button>
      </div>
    </form>
  </div>

  <!-- ERROR STATE -->
  {% if err %}
  <div class="error-banner" role="alert">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
    </svg>
    {{ err }}
  </div>
  {% endif %}

  <!-- TARGET PLAYER CARD -->
  {% if target_player %}
  <div class="player-card">
    <div class="player-card-left">
      <div class="player-card-name">{{ target_player.name }}</div>
      <div class="player-card-meta">
        {% if target_player.position %}
          <span class="pos-badge pos-{{ target_player.position | lower }}">{{ target_player.position }}</span>
        {% endif %}
        <span class="team-label-sm">{{ target_player.proTeam or target_player.team or "" }}</span>
        <span class="status-badge status-injured">Injured</span>
      </div>
    </div>
    <div class="player-card-right">
      <div class="card-stat">
        <span class="card-stat-val">{{ "%.1f" | format(target_player.avg_points) if target_player.avg_points is not none else "—" }}</span>
        <span class="card-stat-label">Avg Pts</span>
      </div>
      <div class="card-stat">
        <span class="card-stat-val proj-col">{{ "%.1f" | format(target_player.projected_avg_points) if target_player.projected_avg_points is not none else "—" }}</span>
        <span class="card-stat-label">Proj Avg</span>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- RESULTS TABLE -->
  {% if replacements %}
  <div class="results-section">
    <div class="results-header">
      <h2>
        Best Replacements
        {% if target_player and target_player.position %}
          <span class="pos-badge pos-{{ target_player.position | lower }}" style="font-size:0.75rem;vertical-align:middle;">{{ target_player.position }}</span>
        {% endif %}
      </h2>
      <span class="results-count">{{ replacements | length }} players found</span>
    </div>

    <!-- position match indicator -->
    <div class="pos-match-note">
      Sorted by predicted PPG for the same position.
      <span class="pos-match-em">Exact position matches ranked highest.</span>
    </div>

    <div class="table-wrapper">
      <table class="results-table">
        <thead>
          <tr>
            <th class="col-rank">#</th>
            <th>Player</th>
            <th class="col-center">Pos</th>
            <th class="col-center">Pos Match</th>
            <th class="col-center">Pred. PPG</th>
            <th class="col-center">Exp. Week Pts</th>
            <th class="col-center">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for player in replacements %}
          <tr class="result-row {% if player.position_match %}match-row{% endif %}">
            <td class="col-rank">
              {% if loop.index == 1 %}<span class="rank-badge rank-1">1</span>
              {% elif loop.index == 2 %}<span class="rank-badge rank-2">2</span>
              {% elif loop.index == 3 %}<span class="rank-badge rank-3">3</span>
              {% else %}<span class="rank-num">{{ loop.index }}</span>{% endif %}
            </td>
            <td><span class="player-name">{{ player.name }}</span></td>
            <td class="col-center">
              <span class="pos-badge pos-{{ player.position | lower }}">{{ player.position }}</span>
            </td>
            <td class="col-center">
              {% if player.position_match %}
                <span class="match-badge">✓ Match</span>
              {% else %}
                <span class="flex-badge">Flex</span>
              {% endif %}
            </td>
            <td class="col-center">
              <span class="ppg-value">{{ "%.1f" | format(player.predicted_ppg) }}</span>
            </td>
            <td class="col-center">
              <div class="week-pts-wrapper">
                <span class="week-pts-value">{{ "%.1f" | format(player.expected_week_points) }}</span>
                <div class="pts-bar-track">
                  <div class="pts-bar-fill" style="width: {{ [((player.expected_week_points / 60) * 100), 100] | min | int }}%"></div>
                </div>
              </div>
            </td>
            <td class="col-center">
              {% if player.injured %}
                <span class="status-badge status-injured">Injured</span>
              {% else %}
                <span class="status-badge status-healthy">Healthy</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% elif form.search.data and not err %}
  <div class="empty-state"><p>No replacements found. Try a different player name.</p></div>
  {% endif %}

  {% if not form.search.data and not err and not replacements %}
  <div class="empty-state">
    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" opacity="0.3">
      <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </svg>
    <p>Search for an injured player above to see position-matched replacement recommendations</p>
  </div>
  {% endif %}
</div>

<style>
.page-header { text-align: center; margin-bottom: 2rem; }
.page-header h1 { font-size: 1.8rem; color: #eaeaea; margin-bottom: 0.4rem; }
.page-subtitle { color: #888; font-size: 0.95rem; }

/* ── View Toggle ─── */
.view-toggle { display: flex; justify-content: center; gap: 6px; margin-bottom: 1.8rem; }
.view-btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 9px 20px; border-radius: 8px;
  background: #1a1a1a; border: 1px solid #2a2a2a;
  color: #666; font-size: 0.85rem; font-weight: 600;
  cursor: pointer; transition: all 0.15s;
}
.view-btn:hover { color: #aaa; border-color: #3a3a3a; background: #222; }
.view-btn.active { color: #7aa2ff; background: #1a2540; border-color: #3a5aaa; }

/* ── Browse header ─── */
.browse-header {
  display: flex; align-items: baseline; justify-content: space-between;
  max-width: 900px; margin: 0 auto 1rem; padding: 0 2px;
}
.browse-header h2 { font-size: 1.1rem; color: #eaeaea; margin: 0; }

/* ── Filter pills ─── */
.filter-bar {
  display: flex; flex-wrap: wrap; gap: 6px; align-items: center;
  max-width: 900px; margin: 0 auto 1rem; padding: 0 2px;
}
.filter-pill {
  padding: 6px 14px; border-radius: 20px; font-size: 0.8rem;
  font-weight: 600; background: #1a1a1a; border: 1px solid #2a2a2a;
  color: #666; cursor: pointer; transition: all 0.15s;
}
.filter-pill:hover { color: #aaa; background: #222; }
.filter-pill.active { color: #7aa2ff; background: #1a2540; border-color: #3a5aaa; }

/* ── Find btn ─── */
.find-btn {
  padding: 6px 12px; background: #1a2540; border: 1px solid #3a5aaa;
  border-radius: 6px; color: #7aa2ff; font-size: 0.78rem; font-weight: 700;
  cursor: pointer; transition: all 0.15s; white-space: nowrap;
}
.find-btn:hover { background: #243660; border-color: #5a7acc; }

/* ── Search ─── */
.search-section { max-width: 600px; margin: 0 auto 2rem; }
.search-bar {
  display: flex; border: 1px solid #3a3a3a; border-radius: 8px;
  overflow: hidden; background: #1a1a1a; transition: border-color 0.2s;
}
.search-bar:focus-within { border-color: #7aa2ff; }
.search-input {
  flex: 1; padding: 12px 16px; background: transparent;
  border: none; outline: none; color: #eaeaea; font-size: 0.95rem;
}
.search-input::placeholder { color: #555; }
.search-btn {
  padding: 12px 22px; background: #7aa2ff; color: #121212;
  border: none; cursor: pointer; font-weight: 700; font-size: 0.9rem;
  transition: background 0.15s; display: flex; align-items: center; gap: 8px;
}
.search-btn:hover { background: #5a8aef; }
.btn-hidden { display: none; }
.btn-spinner svg { animation: spin 0.8s linear infinite; }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* ── Error ─── */
.error-banner {
  max-width: 600px; margin: 0 auto 1.5rem;
  padding: 12px 16px; background: #3a1a1a;
  border: 1px solid #5a2a2a; border-radius: 8px;
  color: #ff8a8a; font-size: 0.9rem;
  display: flex; align-items: center; gap: 8px;
}

/* ── Player Card ─── */
.player-card {
  max-width: 900px; margin: 0 auto 1.5rem;
  padding: 1.2rem 1.5rem; background: #141a22;
  border: 1px solid #3a5aaa; border-radius: 10px;
  display: flex; align-items: center; justify-content: space-between;
  gap: 1rem; flex-wrap: wrap;
}
.player-card-left {}
.player-card-name { font-size: 1.1rem; font-weight: 700; color: #eaeaea; margin-bottom: 6px; }
.player-card-meta { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.player-card-right { display: flex; gap: 1.5rem; }
.card-stat { text-align: center; }
.card-stat-val { display: block; font-size: 1.4rem; font-weight: 800; color: #eaeaea; font-variant-numeric: tabular-nums; }
.proj-col { color: #7aa2ff; }
.card-stat-label { font-size: 0.7rem; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; }

/* ── Pos match note ─── */
.pos-match-note {
  max-width: 900px; margin: 0 auto 0.8rem; padding: 0 2px;
  font-size: 0.8rem; color: #666;
}
.pos-match-em { color: #7aa2ff; font-weight: 600; }

/* ── Results ─── */
.results-section { max-width: 900px; margin: 0 auto 5rem; }
.results-header {
  display: flex; align-items: baseline; justify-content: space-between;
  margin-bottom: 0.5rem; padding: 0 2px;
}
.results-header h2 { font-size: 1.1rem; color: #eaeaea; margin: 0; display: flex; align-items: center; gap: 8px; }
.results-count { font-size: 0.8rem; color: #666; }

/* ── Table ─── */
.table-wrapper { border: 1px solid #2a2a2a; border-radius: 10px; overflow: hidden; }
.results-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
.results-table thead { background: #1e1e1e; border-bottom: 1px solid #2a2a2a; }
.results-table th {
  padding: 11px 14px; text-align: left; font-size: 0.75rem;
  font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; color: #666;
}
.results-table th.col-rank,
.results-table th.col-center { text-align: center; }

.result-row { border-bottom: 1px solid #1e1e1e; transition: background 0.12s; }
.result-row:last-child { border-bottom: none; }
.result-row:hover { background: #1e2530; }
.match-row { background: #0d1a0f; }
.match-row:hover { background: #122014; }

.results-table td { padding: 11px 14px; color: #d0d0d0; vertical-align: middle; }
.results-table td.col-rank,
.results-table td.col-center { text-align: center; }

.rank-badge {
  display: inline-flex; align-items: center; justify-content: center;
  width: 26px; height: 26px; border-radius: 50%;
  font-size: 0.8rem; font-weight: 700;
}
.rank-1 { background: #3a2e0a; color: #ffd700; }
.rank-2 { background: #252525; color: #c0c0c0; }
.rank-3 { background: #2a1a10; color: #cd7f32; }
.rank-num { color: #555; font-size: 0.85rem; }

.player-name { font-weight: 600; color: #eaeaea; }
.team-label-sm { color: #666; font-size: 0.82rem; font-weight: 600; }

.pos-badge {
  display: inline-block; padding: 3px 9px; border-radius: 4px;
  font-size: 0.78rem; font-weight: 700; letter-spacing: 0.04em;
  background: #1e2e4a; color: #7aa2ff;
}

.match-badge {
  display: inline-block; padding: 3px 10px; border-radius: 4px;
  font-size: 0.75rem; font-weight: 700;
  background: #1a3a20; color: #6bcf7f; letter-spacing: 0.04em;
}
.flex-badge {
  display: inline-block; padding: 3px 10px; border-radius: 4px;
  font-size: 0.75rem; font-weight: 700;
  background: #2a2a2a; color: #888; letter-spacing: 0.04em;
}

.avg-value   { font-weight: 700; color: #eaeaea; font-variant-numeric: tabular-nums; }
.ppg-value   { font-weight: 700; color: #c8e6ff; font-variant-numeric: tabular-nums; }
.week-pts-wrapper { display: flex; flex-direction: column; gap: 4px; align-items: center; min-width: 90px; }
.week-pts-value { font-weight: 700; color: #7aa2ff; font-variant-numeric: tabular-nums; }
.pts-bar-track { width: 80px; height: 4px; background: #2a2a2a; border-radius: 2px; overflow: hidden; }
.pts-bar-fill { height: 100%; background: linear-gradient(90deg, #4a7adf, #7aa2ff); border-radius: 2px; transition: width 0.4s ease; }

.status-badge { display: inline-block; padding: 3px 9px; border-radius: 4px; font-size: 0.78rem; font-weight: 600; }
.status-healthy { background: #1e3a2a; color: #6bcf7f; }
.status-injured { background: #3a1e1e; color: #ff8a8a; }

/* ── Empty state ─── */
.empty-state {
  text-align: center; padding: 4rem 2rem; color: #555;
  display: flex; flex-direction: column; align-items: center; gap: 1rem;
}
.empty-state p { font-size: 0.95rem; max-width: 360px; }

.hidden { display: none; }
</style>

<script>
(function () {
  // ── View toggle ─────────────────────────────────────────────
  const viewBrowse = document.getElementById('view-browse');
  const viewSearch = document.getElementById('view-search');
  document.querySelectorAll('.view-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      const v = this.dataset.view;
      viewBrowse.classList.toggle('hidden', v !== 'browse');
      viewSearch.classList.toggle('hidden', v !== 'search');
    });
  });

  {% if replacements or target_player %}
  // Auto-switch to search view if we have results
  document.getElementById('btn-search').click();
  {% endif %}

  // Position filter for injured table
  const pills = document.querySelectorAll('.filter-pill');
  const injRows = Array.from(document.querySelectorAll('.inj-row'));
  pills.forEach(function (pill) {
    pill.addEventListener('click', function () {
      pills.forEach(p => p.classList.remove('active'));
      this.classList.add('active');
      const f = this.dataset.filter;
      injRows.forEach(function (row) {
        const match = f === 'all' || row.dataset.position === f;
        row.style.display = match ? '' : 'none';
      });
    });
  });

  // Search spinner
  const form    = document.getElementById('search-form');
  const btnText = form ? form.querySelector('.btn-text') : null;
  const spinner = form ? form.querySelector('.btn-spinner') : null;
  const input   = document.getElementById('player-search');
  if (form) {
    form.addEventListener('submit', function (e) {
      const val = (input ? input.value : '').trim();
      if (!val) { e.preventDefault(); if (input) input.focus(); return; }
      if (btnText) btnText.classList.add('btn-hidden');
      if (spinner) spinner.classList.remove('btn-hidden');
    });
  }

  // Animate progress bars
  document.querySelectorAll('.pts-bar-fill').forEach(function (bar) {
    const target = bar.style.width;
    bar.style.width = '0%';
    requestAnimationFrame(() => requestAnimationFrame(() => { bar.style.width = target; }));
  });
})();
</script>

{% endblock %}