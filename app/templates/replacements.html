{% extends "base.html" %}

{% block content %}

<div class="page-header">
  <h1>Injury Replacements</h1>
  <p class="page-subtitle">Enter an injured player's name to find the best available replacements</p>
</div>

<!-- SEARCH FORM -->
<div class="search-section">
  <form method="POST" action="{{ url_for('replacements') }}" id="search-form">
    {{ form.hidden_tag() }}
    <div class="search-bar">
      {{ form.search(
          id="player-search",
          placeholder="e.g. LeBron James...",
          autocomplete="off",
          class="search-input"
      ) }}
      <button type="submit" class="search-btn" id="submit-btn">
        <span class="btn-text">Find Replacements</span>
        <span class="btn-spinner hidden">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
          </svg>
        </span>
      </button>
    </div>
  </form>
</div>

<!-- ERROR STATE -->
{% if err %}
<div class="error-banner" role="alert">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
  </svg>
  {{ err }}
</div>
{% endif %}

<!-- RESULTS TABLE -->
{% if replacements %}
<div class="results-section">
  <div class="results-header">
    <h2>Top Free Agent Replacements</h2>
    <span class="results-count">{{ replacements | length }} players found</span>
  </div>

  <div class="table-wrapper">
    <table class="results-table">
      <thead>
        <tr>
          <th class="col-rank">#</th>
          <th class="col-name">Player</th>
          <th class="col-pos">
            <div class="pos-header">
              Position
              <div class="pos-filter-wrap">
                <button class="pos-filter-btn" id="pos-filter-btn" aria-label="Filter by position" title="Filter by position">
                  <!-- funnel icon -->
                  <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                  </svg>
                </button>
                <div class="pos-dropdown" id="pos-dropdown" role="listbox" aria-label="Position filter">
                  <button class="pos-option pos-option-all active" data-pos="all">All</button>
                  <!-- options injected by JS from actual data -->
                </div>
              </div>
            </div>
          </th>
          <th class="col-ppg">Pred. PPG</th>
          <th class="col-week">Expected Week Pts</th>
          <th class="col-status">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for player in replacements %}
        <tr class="result-row {% if loop.index <= 3 %}top-pick{% endif %}">

          <!-- Rank -->
          <td class="col-rank">
            {% if loop.index == 1 %}
              <span class="rank-badge rank-1">1</span>
            {% elif loop.index == 2 %}
              <span class="rank-badge rank-2">2</span>
            {% elif loop.index == 3 %}
              <span class="rank-badge rank-3">3</span>
            {% else %}
              <span class="rank-num">{{ loop.index }}</span>
            {% endif %}
          </td>

          <!-- Name -->
          <td class="col-name">
            <span class="player-name">{{ player.name }}</span>
          </td>

          <!-- Position -->
          <td class="col-pos">
            <span class="pos-badge pos-{{ player.position | lower }}">{{ player.position }}</span>
          </td>

          <!-- Predicted PPG -->
          <td class="col-ppg">
            <span class="ppg-value">{{ "%.1f" | format(player.predicted_ppg) }}</span>
          </td>

          <!-- Expected Week Points -->
          <td class="col-week">
            <div class="week-pts-wrapper">
              <span class="week-pts-value">{{ "%.1f" | format(player.expected_week_points) }}</span>
              <div class="pts-bar-track">
                {# Normalize bar width: cap visual at 60 pts max #}
                <div class="pts-bar-fill" style="width: {{ [((player.expected_week_points / 60) * 100), 100] | min | int }}%"></div>
              </div>
            </div>
          </td>

          <!-- Injury Status -->
          <td class="col-status">
            {% if player.injured %}
              <span class="status-badge status-injured">Injured</span>
            {% else %}
              <span class="status-badge status-healthy">Healthy</span>
            {% endif %}
          </td>

        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% elif form.search.data and not err %}
<!-- Submitted but no results (edge case) -->
<div class="empty-state">
  <p>No replacements found. Try a different player name.</p>
</div>
{% endif %}

<!-- EMPTY / INITIAL STATE (no search submitted yet) -->
{% if not form.search.data and not err and not replacements %}
<div class="empty-state">
  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" opacity="0.3">
    <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
  </svg>
  <p>Search for an injured player above to see replacement recommendations</p>
</div>
{% endif %}

<style>
/* ── Layout ──────────────────────────────────────────────── */
.page-header {
  text-align: center;
  margin-bottom: 2rem;
}

.page-header h1 {
  font-size: 1.8rem;
  color: #eaeaea;
  margin-bottom: 0.4rem;
}

.page-subtitle {
  color: #888;
  font-size: 0.95rem;
}

/* ── Search Bar ──────────────────────────────────────────── */
.search-section {
  max-width: 600px;
  margin: 0 auto 2rem;
}

.search-bar {
  display: flex;
  gap: 0;
  border: 1px solid #3a3a3a;
  border-radius: 8px;
  overflow: hidden;
  background: #1a1a1a;
  transition: border-color 0.2s;
}

.search-bar:focus-within {
  border-color: #7aa2ff;
}

.search-input {
  flex: 1;
  padding: 12px 16px;
  background: transparent;
  border: none;
  outline: none;
  color: #eaeaea;
  font-size: 0.95rem;
}

.search-input::placeholder {
  color: #555;
}

.search-btn {
  padding: 12px 22px;
  background: #7aa2ff;
  color: #121212;
  border: none;
  cursor: pointer;
  font-weight: 700;
  font-size: 0.9rem;
  transition: background 0.15s;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

.search-btn:hover {
  background: #5a8aef;
}

.search-btn:active {
  background: #4a7adf;
}

/* Spinner */
.hidden { display: none; }

.btn-spinner svg {
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

/* ── Error Banner ────────────────────────────────────────── */
.error-banner {
  max-width: 600px;
  margin: 0 auto 1.5rem;
  padding: 12px 16px;
  background: #3a1a1a;
  border: 1px solid #5a2a2a;
  border-radius: 8px;
  color: #ff8a8a;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ── Results ─────────────────────────────────────────────── */
.results-section {
  max-width: 900px;
  margin: 0 auto;
}

.results-header {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  margin-bottom: 1rem;
  padding: 0 2px;
}

.results-header h2 {
  font-size: 1.1rem;
  color: #eaeaea;
  margin: 0;
}

.results-count {
  font-size: 0.8rem;
  color: #666;
}

/* ── Table ───────────────────────────────────────────────── */
.table-wrapper {
  border: 1px solid #2a2a2a;
  border-radius: 10px;
  overflow: hidden;
}

.results-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.9rem;
}

.results-table thead {
  background: #1e1e1e;
  border-bottom: 1px solid #2a2a2a;
}

.results-table th {
  padding: 11px 14px;
  text-align: left;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: #666;
}

.results-table th.col-ppg,
.results-table th.col-week,
.results-table th.col-status,
.results-table th.col-rank {
  text-align: center;
}

.result-row {
  border-bottom: 1px solid #1e1e1e;
  transition: background 0.12s;
}

.result-row:last-child {
  border-bottom: none;
}

.result-row:hover {
  background: #1e2530;
}

.result-row.top-pick {
  background: #141a22;
}

.result-row.top-pick:hover {
  background: #1a2435;
}

.results-table td {
  padding: 12px 14px;
  color: #d0d0d0;
  vertical-align: middle;
}

.results-table td.col-rank,
.results-table td.col-ppg,
.results-table td.col-status {
  text-align: center;
}

/* Rank badges */
.rank-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 26px;
  height: 26px;
  border-radius: 50%;
  font-size: 0.8rem;
  font-weight: 700;
}

.rank-1 { background: #3a2e0a; color: #ffd700; }
.rank-2 { background: #252525; color: #c0c0c0; }
.rank-3 { background: #2a1a10; color: #cd7f32; }

.rank-num {
  color: #555;
  font-size: 0.85rem;
}

/* Player name */
.player-name {
  font-weight: 600;
  color: #eaeaea;
}

/* Position badges */
.pos-badge {
  display: inline-block;
  padding: 3px 9px;
  border-radius: 4px;
  font-size: 0.78rem;
  font-weight: 700;
  letter-spacing: 0.04em;
}

.pos-pg, .pos-sg, .pos-sf, .pos-pf, .pos-c,
.pos-g, .pos-f { background: #1e2e4a; color: #7aa2ff; }
.pos-util      { background: #2a2040; color: #b07aff; }

/* Fallback for any position */
.pos-badge:not([class*="pos-"]) {
  background: #2a2a2a; color: #aaa;
}

/* PPG value */
.ppg-value {
  font-weight: 600;
  font-variant-numeric: tabular-nums;
  color: #c8e6ff;
}

/* Week pts bar */
.week-pts-wrapper {
  display: flex;
  flex-direction: column;
  gap: 5px;
  align-items: flex-start;
  min-width: 120px;
}

.week-pts-value {
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  color: #7aa2ff;
  font-size: 0.95rem;
}

.pts-bar-track {
  width: 100%;
  height: 4px;
  background: #2a2a2a;
  border-radius: 2px;
  overflow: hidden;
}

.pts-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #4a7adf, #7aa2ff);
  border-radius: 2px;
  transition: width 0.4s ease;
}

/* Status badges */
.status-badge {
  display: inline-block;
  padding: 3px 9px;
  border-radius: 4px;
  font-size: 0.78rem;
  font-weight: 600;
}

.status-healthy { background: #1e3a2a; color: #6bcf7f; }
.status-injured { background: #3a1e1e; color: #ff8a8a; }

/* ── Position Filter ─────────────────────────────────────── */
.pos-header {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  position: relative;
}

.pos-filter-wrap {
  position: relative;
}

.pos-filter-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  background: none;
  border: 1px solid transparent;
  border-radius: 4px;
  color: #555;
  cursor: pointer;
  transition: color 0.15s, border-color 0.15s, background 0.15s;
  padding: 0;
  vertical-align: middle;
}

.pos-filter-btn:hover {
  color: #aaa;
  border-color: #3a3a3a;
  background: #222;
}

.pos-filter-btn.active {
  color: #7aa2ff;
  border-color: #3a5aaa;
  background: #1a2540;
}

.pos-dropdown {
  display: none;
  position: absolute;
  top: calc(100% + 6px);
  left: 50%;
  transform: translateX(-50%);
  background: #1e1e1e;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 6px;
  z-index: 100;
  min-width: 110px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.5);
  display: none;
  flex-direction: column;
  gap: 2px;
}

.pos-dropdown.open {
  display: flex;
  animation: dropIn 0.12s ease;
}

@keyframes dropIn {
  from { opacity: 0; transform: translateX(-50%) translateY(-4px); }
  to   { opacity: 1; transform: translateX(-50%) translateY(0); }
}

.pos-option {
  padding: 6px 12px;
  background: none;
  border: none;
  border-radius: 5px;
  color: #999;
  font-size: 0.78rem;
  font-weight: 600;
  text-align: left;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  transition: background 0.1s, color 0.1s;
  white-space: nowrap;
}

.pos-option:hover {
  background: #2a2a2a;
  color: #eaeaea;
}

.pos-option.active {
  background: #1a2540;
  color: #7aa2ff;
}

/* Filtered-out rows */
.result-row.pos-hidden {
  display: none;
}

/* ── Empty State ─────────────────────────────────────────── */
.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: #555;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.empty-state p {
  font-size: 0.95rem;
  max-width: 360px;
}
</style>

<script>
(function () {
  const form    = document.getElementById('search-form');
  const btnText = document.querySelector('.btn-text');
  const spinner = document.querySelector('.btn-spinner');
  const input   = document.getElementById('player-search');

  // Show spinner on submit so user knows the model is running (it takes a moment)
  form.addEventListener('submit', function (e) {
    const val = (input.value || '').trim();
    if (!val) {
      e.preventDefault();
      input.focus();
      return;
    }
    btnText.classList.add('hidden');
    spinner.classList.remove('hidden');
  });

  // ── Position filter ────────────────────────────────────────
  const filterBtn      = document.getElementById('pos-filter-btn');
  const dropdown       = document.getElementById('pos-dropdown');
  const allRows        = Array.from(document.querySelectorAll('.result-row'));
  const resultsCount   = document.querySelector('.results-count');
  const totalCount     = allRows.length;

  if (filterBtn && dropdown) {
    // Build position options dynamically from actual data in the table
    const positions = [...new Set(
      allRows.map(r => {
        const badge = r.querySelector('.pos-badge');
        return badge ? badge.textContent.trim().toUpperCase() : null;
      }).filter(Boolean)
    )].sort();

    positions.forEach(pos => {
      const btn = document.createElement('button');
      btn.className = 'pos-option';
      btn.dataset.pos = pos;
      btn.textContent = pos;
      btn.setAttribute('role', 'option');
      dropdown.appendChild(btn);
    });

    // Toggle dropdown open/close
    filterBtn.addEventListener('click', function (e) {
      e.stopPropagation();
      dropdown.classList.toggle('open');
    });

    // Close on outside click
    document.addEventListener('click', function () {
      dropdown.classList.remove('open');
    });

    dropdown.addEventListener('click', function (e) {
      e.stopPropagation();
    });

    // Filter logic
    let activePos = 'all';

    dropdown.addEventListener('click', function (e) {
      const opt = e.target.closest('.pos-option');
      if (!opt) return;

      activePos = opt.dataset.pos;

      // Update active styles on options
      dropdown.querySelectorAll('.pos-option').forEach(o => o.classList.remove('active'));
      opt.classList.add('active');

      // Show/hide rows
      let visibleCount = 0;
      allRows.forEach(row => {
        const badge = row.querySelector('.pos-badge');
        const rowPos = badge ? badge.textContent.trim().toUpperCase() : '';
        const show = activePos === 'all' || rowPos === activePos;
        row.classList.toggle('pos-hidden', !show);
        if (show) visibleCount++;
      });

      // Update count label
      if (resultsCount) {
        resultsCount.textContent = activePos === 'all'
          ? `${totalCount} players found`
          : `${visibleCount} of ${totalCount} players`;
      }

      // Toggle active state on filter button itself
      filterBtn.classList.toggle('active', activePos !== 'all');

      dropdown.classList.remove('open');
    });
  }
  document.querySelectorAll('.pts-bar-fill').forEach(function (bar) {
    const target = bar.style.width;
    bar.style.width = '0%';
    // Slight delay so CSS transition fires after paint
    requestAnimationFrame(function () {
      requestAnimationFrame(function () {
        bar.style.width = target;
      });
    });
  });
})();
</script>

{% endblock %}