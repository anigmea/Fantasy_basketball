{% extends "base.html" %}

{% block content %}

<div class="page-header">
  <h1>Trade Analyzer</h1>
  <p class="page-subtitle">Compare up to 4 players per side ‚Äî imbalanced trades are automatically weighted</p>
</div>

<!-- TRADE INPUT FORM -->
<form method="POST" action="{{ url_for('trade') }}" id="trade-form">

  <div class="trade-form-wrapper">

    <!-- YOU GIVE -->
    <div class="trade-side" id="side-give">
      <div class="side-label"><span class="side-label-text">You Give</span></div>
      <div class="player-slots" id="slots-give">
        {% for i in range(4) %}
        <div class="player-slot">
          <input
            type="text"
            name="give_player_{{ i }}"
            class="player-input"
            placeholder="{% if i == 0 %}Player name...{% else %}+ Add player{% endif %}"
            autocomplete="off"
            value="{{ request.form.get('give_player_' ~ i, '') }}"
          />
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- FOR divider -->
    <div class="for-divider">
      <div class="for-line"></div>
      <span class="for-text">FOR</span>
      <div class="for-line"></div>
    </div>

    <!-- YOU RECEIVE -->
    <div class="trade-side" id="side-receive">
      <div class="side-label"><span class="side-label-text">You Receive</span></div>
      <div class="player-slots" id="slots-receive">
        {% for i in range(4) %}
        <div class="player-slot">
          <input
            type="text"
            name="receive_player_{{ i }}"
            class="player-input"
            placeholder="{% if i == 0 %}Player name...{% else %}+ Add player{% endif %}"
            autocomplete="off"
            value="{{ request.form.get('receive_player_' ~ i, '') }}"
          />
        </div>
        {% endfor %}
      </div>
    </div>

  </div>

  <!-- Trade count hint -->
  <div class="trade-hint" id="trade-hint"></div>

  <!-- Analyze button -->
  <div class="analyze-btn-wrapper">
    <button type="submit" class="analyze-btn" id="analyze-btn">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
      </svg>
      Analyze Trade
    </button>
  </div>

</form>

<!-- ERROR STATE -->
{% if err %}
<div class="error-banner" role="alert">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
  </svg>
  {{ err }}
</div>
{% endif %}

<!-- ANALYSIS RESULTS -->
{% if result %}

{% set team_a = result.team_a %}
{% set team_b = result.team_b %}
{% set give_names  = result.give_names  or [] %}
{% set recv_names  = result.recv_names  or [] %}

<!-- TRADE SUMMARY HEADER -->
<div class="analysis-header">
  <div class="trade-names give-color">
    {% for n in give_names %}<span class="trade-name-chip give-chip">{{ n }}</span>{% endfor %}
  </div>
  <div class="vs-text">for</div>
  <div class="trade-names receive-color">
    {% for n in recv_names %}<span class="trade-name-chip recv-chip">{{ n }}</span>{% endfor %}
  </div>
</div>

<!-- Imbalance notice -->
{% if result.imbalance_note %}
<div class="imbalance-notice">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
    <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
  </svg>
  {{ result.imbalance_note }}
</div>
{% endif %}

<!-- VERDICT CARD -->
<div class="results-section">
  <div class="balance-card">
    <div class="balance-sides">
      <div class="balance-side-name give-color">You Give</div>
      <div class="balance-verdict
        {% if score is not none %}
          {% if score | abs < 1 %}verdict-even
          {% elif score > 0 %}verdict-good
          {% else %}verdict-bad{% endif %}
        {% endif %}
      ">
        {% if score is not none %}
          {% if score | abs < 1 %}‚öñÔ∏è Even Trade
          {% elif score > 5 %}üü¢ Great Value for You
          {% elif score > 0 %}üü° Slight Advantage
          {% elif score < -5 %}üî¥ You're Giving Too Much
          {% else %}üü† Slight Disadvantage{% endif %}
        {% endif %}
      </div>
      <div class="balance-side-name receive-color">You Receive</div>
    </div>

    {% set pre_a = team_a.pre_trade_value %}
    {% set pre_b = team_b.pre_trade_value %}
    {% set total_val = pre_a + pre_b %}
    {% set give_pct = ((pre_a / total_val) * 100) | int if total_val > 0 else 50 %}

    <div class="balance-bar-track">
      <div class="balance-bar-fill" id="balance-bar"
           data-width="{{ give_pct }}"
           style="width: 0%;
             {% if score is not none and score | abs < 1 %}background: linear-gradient(90deg,#4a7adf,#5abf6f);
             {% elif score is not none and score > 0 %}background: linear-gradient(90deg,#4a7adf,#6bcf7f);
             {% else %}background: linear-gradient(90deg,#4a7adf,#7aa2ff);{% endif %}
           "></div>
      <div class="balance-bar-marker"></div>
    </div>

    <div class="balance-scores">
      <div class="balance-score-block">
        <span class="balance-score give-color">{{ "%.1f" | format(pre_a) }}</span>
        <span class="balance-score-label">You Give</span>
      </div>
      {% if result.imbalance_note %}
      <div class="balance-score-block center-block">
        <span class="penalty-label">‚ö†Ô∏è Imbalance Penalty Applied</span>
      </div>
      {% endif %}
      <div class="balance-score-block" style="text-align:right">
        <span class="balance-score receive-color">{{ "%.1f" | format(pre_b) }}</span>
        <span class="balance-score-label">You Receive</span>
      </div>
    </div>
  </div>
</div>

<!-- VALUE IMPACT TABLE -->
<div class="results-section">
  <div class="results-header"><h2>Value Impact</h2></div>
  <div class="table-wrapper">
    <table class="results-table">
      <thead>
        <tr>
          <th>Side</th>
          <th class="col-center">Players</th>
          <th class="col-center">Raw Value</th>
          <th class="col-center">Adj. Value</th>
          <th class="col-center">Net Delta</th>
        </tr>
      </thead>
      <tbody>
        <tr class="result-row">
          <td><span class="side-badge give-color">You Give</span></td>
          <td class="col-center"><span class="pts-dim">{{ result.give_count }} player{% if result.give_count != 1 %}s{% endif %}</span></td>
          <td class="col-center"><span class="pts-value give-color">{{ "%.1f" | format(team_a.raw_value) }}</span></td>
          <td class="col-center"><span class="pts-value">{{ "%.1f" | format(team_a.pre_trade_value) }}</span></td>
          <td class="col-center">
            <span class="delta-value {% if team_a.delta >= 0 %}delta-pos{% else %}delta-neg{% endif %}">
              {% if team_a.delta >= 0 %}+{% endif %}{{ "%.1f" | format(team_a.delta) }}
            </span>
          </td>
        </tr>
        <tr class="result-row">
          <td><span class="side-badge receive-color">You Receive</span></td>
          <td class="col-center"><span class="pts-dim">{{ result.recv_count }} player{% if result.recv_count != 1 %}s{% endif %}</span></td>
          <td class="col-center"><span class="pts-value receive-color">{{ "%.1f" | format(team_b.raw_value) }}</span></td>
          <td class="col-center"><span class="pts-value">{{ "%.1f" | format(team_b.pre_trade_value) }}</span></td>
          <td class="col-center">
            <span class="delta-value {% if team_b.delta >= 0 %}delta-pos{% else %}delta-neg{% endif %}">
              {% if team_b.delta >= 0 %}+{% endif %}{{ "%.1f" | format(team_b.delta) }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- PLAYER BREAKDOWN CHART -->
<div class="results-section">
  <div class="results-header"><h2>Player Value Breakdown</h2></div>
  <div class="chart-card">
    <canvas id="trade-chart" height="220"></canvas>
  </div>
</div>

<!-- PLAYER DETAIL CARDS  -->
{% if result.player_details %}
<div class="results-section last-section">
  <div class="results-header"><h2>Player Details</h2></div>
  <div class="player-details-grid">
    {% for p in result.player_details %}
    <div class="player-detail-card {% if p.side == 'give' %}give-card{% else %}recv-card{% endif %}">
      <div class="detail-header-row">
        <span class="detail-name">{{ p.name }}</span>
        <span class="pos-badge pos-{{ p.position | lower if p.position else 'u' }}">{{ p.position or "‚Äî" }}</span>
      </div>
      <div class="detail-stats">
        <div class="detail-stat">
          <span class="detail-val">{{ "%.1f" | format(p.avg_points) if p.avg_points is not none else "‚Äî" }}</span>
          <span class="detail-label">Avg Pts</span>
        </div>
        <div class="detail-stat">
          <span class="detail-val proj-col">{{ "%.1f" | format(p.projected_avg_points) if p.projected_avg_points is not none else "‚Äî" }}</span>
          <span class="detail-label">Proj Avg</span>
        </div>
        <div class="detail-stat">
          <span class="detail-val {% if p.side == 'give' %}give-color{% else %}receive-color{% endif %}">{{ "%.1f" | format(p.trade_value) }}</span>
          <span class="detail-label">Trade Value</span>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% elif not err %}
<div class="empty-state">
  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2" opacity="0.3">
    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
  </svg>
  <p>Enter players above and click Analyze Trade to see results</p>
</div>
{% endif %}

<style>
.page-header { text-align: center; margin-bottom: 2rem; }
.page-header h1 { font-size: 1.8rem; color: #eaeaea; margin-bottom: 0.4rem; }
.page-subtitle { color: #888; font-size: 0.95rem; }

/* Error */
.error-banner {
  max-width: 820px; margin: 0 auto 1.5rem;
  padding: 12px 16px; background: #3a1a1a;
  border: 1px solid #5a2a2a; border-radius: 8px;
  color: #ff8a8a; font-size: 0.9rem;
  display: flex; align-items: center; gap: 8px;
}

/* Trade Form */
.trade-form-wrapper {
  display: flex; align-items: stretch;
  max-width: 820px; margin: 0 auto 1rem;
  background: #1a1a1a; border: 1px solid #2a2a2a;
  border-radius: 12px; overflow: hidden;
}
.trade-side { flex: 1; padding: 2rem; }
#side-give   { background: #141a22; border-right: 1px solid #2a2a2a; }
#side-receive { background: #1a1a1a; }

.side-label { margin-bottom: 1rem; }
.side-label-text {
  font-size: 0.72rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.1em; color: #555;
}
.player-slots { display: flex; flex-direction: column; gap: 8px; }
.player-input {
  width: 100%; padding: 10px 13px;
  background: #111825; border: 1px solid #2a3a5a;
  border-radius: 7px; color: #eaeaea; font-size: 0.9rem;
  font-weight: 600; outline: none;
  transition: border-color 0.15s, opacity 0.15s; box-sizing: border-box;
}
.player-input:focus { border-color: #7aa2ff; }
.player-input::placeholder { color: #333; font-weight: 400; font-style: italic; }
.player-input:not(:placeholder-shown) { border-color: #3a5aaa; }

.for-divider {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 2rem 1rem; gap: 8px; min-width: 52px;
}
.for-line { width: 1px; flex: 1; background: #2a2a2a; }
.for-text { font-size: 0.7rem; font-weight: 700; letter-spacing: 0.12em; color: #444; }

.trade-hint { text-align: center; font-size: 0.8rem; color: #666; margin-bottom: 1rem; min-height: 1.2em; }

.analyze-btn-wrapper { display: flex; justify-content: center; margin-bottom: 2.5rem; }
.analyze-btn {
  display: inline-flex; align-items: center; gap: 10px;
  padding: 14px 36px; background: #7aa2ff; color: #0a0a0a;
  border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 700;
  cursor: pointer; letter-spacing: 0.03em; transition: background 0.15s, transform 0.1s;
}
.analyze-btn:hover  { background: #5a8aef; }
.analyze-btn:active { transform: scale(0.98); }

/* Analysis header */
.analysis-header {
  display: flex; align-items: flex-start; justify-content: center;
  gap: 1rem; margin-bottom: 1.5rem; text-align: center; flex-wrap: wrap;
}
.trade-names { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; max-width: 300px; }
.trade-name-chip {
  display: inline-block; padding: 5px 12px; border-radius: 6px;
  font-size: 0.88rem; font-weight: 700;
}
.give-chip { background: #1a2540; color: #7aa2ff; }
.recv-chip { background: #1a2e1a; color: #6bcf7f; }
.vs-text { font-size: 0.8rem; color: #555; font-weight: 600; align-self: center; white-space: nowrap; }

/* Imbalance notice */
.imbalance-notice {
  max-width: 820px; margin: 0 auto 1.5rem;
  padding: 10px 16px; background: #1e1a0a;
  border: 1px solid #4a3a10; border-radius: 8px;
  color: #ffd93d; font-size: 0.85rem;
  display: flex; align-items: center; gap: 8px;
}

/* Results section */
.results-section { max-width: 820px; margin: 0 auto 2rem; }
.results-header { display: flex; align-items: baseline; justify-content: space-between; margin-bottom: 1rem; padding: 0 2px; }
.results-header h2 { font-size: 1.1rem; color: #eaeaea; margin: 0; }

/* Balance card */
.balance-card {
  background: #1a1a1a; border: 1px solid #2a2a2a;
  border-radius: 10px; padding: 1.5rem 2rem;
}
.balance-sides {
  display: flex; justify-content: space-between;
  align-items: center; margin-bottom: 1rem;
}
.balance-side-name { font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; }
.balance-verdict { font-size: 0.9rem; font-weight: 700; text-align: center; }
.verdict-even { color: #ffd93d; }
.verdict-good { color: #6bcf7f; }
.verdict-bad  { color: #ff8a8a; }

.balance-bar-track {
  position: relative; height: 12px;
  background: #2a2a2a; border-radius: 6px; overflow: hidden; margin-bottom: 1rem;
}
.balance-bar-fill { position: absolute; top: 0; left: 0; height: 100%; border-radius: 6px; transition: width 0.6s cubic-bezier(.4,0,.2,1); }
.balance-bar-marker { position: absolute; top: 0; left: 50%; width: 2px; height: 100%; background: #3a3a3a; transform: translateX(-50%); }

.balance-scores { display: flex; justify-content: space-between; align-items: flex-start; }
.balance-score-block { display: flex; flex-direction: column; }
.center-block { align-items: center; }
.balance-score { font-size: 1.3rem; font-weight: 800; font-variant-numeric: tabular-nums; }
.balance-score-label { font-size: 0.7rem; color: #555; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
.penalty-label { font-size: 0.75rem; color: #ffd93d; font-weight: 600; }

/* Table */
.table-wrapper { border: 1px solid #2a2a2a; border-radius: 10px; overflow: hidden; }
.results-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
.results-table thead { background: #1e1e1e; border-bottom: 1px solid #2a2a2a; }
.results-table th {
  padding: 11px 14px; text-align: left; font-size: 0.75rem;
  font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; color: #666;
}
.results-table th.col-center { text-align: center; }
.result-row { border-bottom: 1px solid #1e1e1e; transition: background 0.12s; }
.result-row:last-child { border-bottom: none; }
.result-row:hover { background: #1e2530; }
.results-table td { padding: 12px 14px; color: #d0d0d0; vertical-align: middle; }
.results-table td.col-center { text-align: center; }

.side-badge { font-weight: 700; font-size: 0.9rem; }
.pts-value { font-weight: 700; font-variant-numeric: tabular-nums; color: #eaeaea; }
.pts-dim { font-size: 0.82rem; color: #555; }
.delta-value { font-weight: 800; font-variant-numeric: tabular-nums; }
.delta-pos { color: #6bcf7f; }
.delta-neg { color: #ff8a8a; }

/* ‚îÄ‚îÄ Chart ‚îÄ‚îÄ‚îÄ */
.chart-card {
  background: #1a1a1a; border: 1px solid #2a2a2a;
  border-radius: 10px; padding: 1.5rem;
}

/* Player detail cards */
.player-details-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;
}
.player-detail-card {
  padding: 1rem 1.2rem; border-radius: 10px;
  border: 1px solid #2a2a2a; background: #161616;
}
.give-card { border-color: #1e3050; background: #111825; }
.recv-card { border-color: #1e3020; background: #111a12; }
.detail-header-row { display: flex; align-items: center; gap: 8px; margin-bottom: 0.8rem; flex-wrap: wrap; }
.detail-name { font-weight: 700; color: #eaeaea; font-size: 0.9rem; flex: 1; }
.pos-badge {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 0.72rem; font-weight: 700; letter-spacing: 0.04em;
  background: #1e2e4a; color: #7aa2ff;
}
.detail-stats { display: flex; gap: 1rem; }
.detail-stat { display: flex; flex-direction: column; }
.detail-val { font-size: 1.05rem; font-weight: 800; font-variant-numeric: tabular-nums; color: #eaeaea; }
.proj-col { color: #7aa2ff; }
.detail-label { font-size: 0.65rem; color: #555; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }

.give-color    { color: #7aa2ff; }
.receive-color { color: #6bcf7f; }

/* Empty State */
.empty-state {
  text-align: center; padding: 4rem 2rem; color: #555;
  display: flex; flex-direction: column; align-items: center; gap: 1rem;
}
.empty-state p { font-size: 0.95rem; max-width: 360px; }

.last-section {
  margin-bottom: 6rem;
}
</style>

{% if result %}
<!-- Chart.js for player value breakdown -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
(function () {
  const details = {{ result.player_details | tojson if result.player_details else '[]' }};
  if (!details.length) return;

  const labels = details.map(p => p.name);
  const values = details.map(p => p.trade_value || 0);
  const colors = details.map(p => p.side === 'give' ? 'rgba(122, 162, 255, 0.75)' : 'rgba(107, 207, 127, 0.75)');
  const borders = details.map(p => p.side === 'give' ? '#7aa2ff' : '#6bcf7f');

  const ctx = document.getElementById('trade-chart');
  if (!ctx) return;

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Trade Value (Avg Pts)',
        data: values,
        backgroundColor: colors,
        borderColor: borders,
        borderWidth: 1.5,
        borderRadius: 5,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#1e1e1e',
          borderColor: '#3a3a3a',
          borderWidth: 1,
          titleColor: '#eaeaea',
          bodyColor: '#aaa',
          callbacks: {
            label: ctx => ' ' + ctx.parsed.y.toFixed(1) + ' pts avg'
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#888', font: { size: 11, weight: '600' } },
          grid: { color: '#1e1e1e' }
        },
        y: {
          ticks: { color: '#666', font: { size: 10 } },
          grid: { color: '#222' },
          beginAtZero: true
        }
      }
    }
  });

  // Animate balance bar
  const bar = document.getElementById('balance-bar');
  if (bar) {
    const w = bar.dataset.width;
    requestAnimationFrame(() => requestAnimationFrame(() => { bar.style.width = w + '%'; }));
  }
})();
</script>
{% else %}
<script>
// Animate balance bar without chart
const bar = document.getElementById('balance-bar');
if (bar) {
  const w = bar.dataset.width;
  requestAnimationFrame(() => requestAnimationFrame(() => { bar.style.width = w + '%'; }));
}
</script>
{% endif %}

<script>
(function () {
  // Trade hint: show player counts as user fills slots
  const giveInputs    = document.querySelectorAll('[name^="give_player_"]');
  const receiveInputs = document.querySelectorAll('[name^="receive_player_"]');
  const hint          = document.getElementById('trade-hint');

  function countFilled(inputs) {
    return Array.from(inputs).filter(i => i.value.trim()).length;
  }

  function updateHint() {
    const g = countFilled(giveInputs);
    const r = countFilled(receiveInputs);
    if (!g && !r) { hint.textContent = ''; return; }
    if (g === r) {
      hint.textContent = `${g}v${r} trade ‚Äî balanced`;
      hint.style.color = '#6bcf7f';
    } else if (g > 0 && r > 0) {
      hint.textContent = `${g}v${r} trade ‚Äî imbalance penalty applied to the larger side`;
      hint.style.color = '#ffd93d';
    } else {
      hint.textContent = '';
    }
  }

  [...giveInputs, ...receiveInputs].forEach(i => i.addEventListener('input', updateHint));
  updateHint();
})();
</script>

{% endblock %}